# 7장-cache

### cache의 혜택

- 캐시는 불필요한 데이터 전송을 줄여서, 네트워크 요금으로 인한 비용을 줄여준다.
- 캐시는 네트워크 병목을 줄여준다. 대역폭을 늘리지 않고도 페이지를 빨리 불러올 수 있게 된다.
- 캐시는 원서버에 대한 요청을 줄여준다. 서버는 부하를 줄일 수 있으며 더 빨리 응답할 수 있게 된다.
- 페이지를 먼 곳에서 불러올 수록 시간이 많이 걸리는데, 캐시는 거리로 인한 지연을 줄여준다.

### 목표

- 캐시가 어떻게 성능을 개선하고 비용을 줄이는지,
- 어떻게 그 효과를 측정하는지,
- 효과를 극대화하기 위해 캐시를 어디에 위치시켜야 하는지,
- 어떻게 HTTP가 캐시된 사본을 신선하게 유지시키는지,
- 어떻게 다른 캐시가 다른 캐시나 서버와 상호작용하는지,

- 불필요한 데이터 전송
    - 복수의 클라이언트가 자주 쓰이는 원 서버 페이지에 접근할 때, 서버는 같은 문서를 클라이언트들에게 각각 한번씩 전송하게 된다. 똑같은 바이트들이 네트워크를 통해 계속 반복해서 이동한다. → 이 불필요한 데이터 전송은 **네트워크 대역폭을 잡아먹고**, **전송을 느리게 만들며**, **웹서버에 부하**를 준다.
    - 캐시를 이용하면 첫번째 서버 응답은 캐시에 보관된다. 캐시된 사본이 뒤이은 요청들에 대한 응답으로 사용될 수 있기 때문에, 원 서버가 중복해서 트래픽을 주고받는 낭비가 줄어들게된다.
- 대역폭 병목
    - 많은 서버가 원격서버보다 **로컬네트워크 클라이언트**에게 더 넓은 대역폭을 제공한다.
    - 클라이언트들이 서버에 접근할 때 속도는, 그 경로에 있는 가장 느린 네트워크의 속도와 같다.
    - 만약 클라이언트가 빠른 LAN에 있는 캐시로부터 사본을 가져온다면, 캐시는 성능을 대폭 개선할 수 있을 것이다. 특히 큰 문서들에 대해
- 갑작스런 요청 쇄도
    - 초래된 불필요한 트래픽 급증은 네트워크와 웹 서버의 심각한 장애를 일으킨다
- 거리로 인한 지연
    - 모든 네트워크 라우터는 제 각각 인터넷 트래픽을 지연시킨다
- 적중과 부적중
    - 캐시 적중 cache hit : 캐시에 요청이 도착했을 때, 그에 대응하는 사본이 있다면 이를 이용해 요청이 처리될 수 있다.
    - 캐시 부적중 cache miss : 대응하는 사본이 없다면 그냥 원서버로 전달된다.
    - 재검사 revalidation : 원 서버 콘텐츠는 변경됨→ 사본이 여전히 최신인지 검사해야 됨
        
        → `신선도 검사` : 클라이언트가 요청한 사본이 검사를 할 필요가 있을정도로 충분히 오래된 경우에만 재검사
        
        → 검사 필요 없을 때, 서버는 `304 Not Modified` 응답을 보낸다 : 재검사 적중, 느린 적중
        
    - 속도
        
        (느림) 캐시 부적중 < 재검사 적중 < 순수 캐시 적중
        
    - HTTP가 캐시된 객체를 재확인하기 위해 제공하는 도구
        - GET요청의 헤더 : `If-Modified-Since` → 캐시된 시간 이후 변경된 경우에만 사본을 보내달라는 의미
        - `If-Modified-Since` 요청이 서버에 도착했을 때, 일어나는 세가지 상황
            1. 서버 콘텐츠가 변경되지 않은 경우 : 재검사 적중 `304 Not Modified`
            2. 서버 콘텐츠가 변경된 경우 : 재검사 부적중 `200 OK`
            3. 객체가 삭제된 경우 : 객체 삭제 `404 Not Found`
    - 적중률
        - 0% : 0 : 모든 요청이 캐시 부적중(네트워크 너머로 문서를 가져와야 했던 경우)
        - 100% : 1 : 모든 요청이 캐시 적중(캐시에서 사본을 가져온 경우)
    - 바이트 적중률
    - 적중과 부적중의 구별 : 클라이언트는 둘다 200 OK로 받기 때문에 모른다
        - 구별 방법1 : Date 헤더 : 오래되면 캐시에서 가져온것
        - 구별 방법2 : Age 헤더 : 얼마나 오래 되었는지 말해줌
- 캐시 토플로지
    
    캐시는 한명의 사용자에게만 할당 될수도 있고 수천명의 사용자들 간에 공유될 수도 있다
    
    - 개인 전용 캐시 : 한 명에만 할당된 캐시 → 사용자가 자주 찾는 페이지를 담는다
        
        → 개인용 컴퓨터/디스크에 캐시, 들여다보기도 가능 
        
    - 공용 캐시 : 공유된 캐시 → 사용자 집단에게 자주 쓰이는 페이지를 담는다
        
        → 프락시 캐시(서버)라는 공유된 프락시 서버
        
- 캐시망, 콘텐츠 라우팅, 피어링
    
    몇몇 네트워크 아키텍쳐는 단순한 캐시 계층 대신 복잡한 캐시망을 만든다. 캐시망의 프락시 캐시는 복잡한 방법으로 서로 대화하여, 어떤 부모 캐시와 대화할 것인지, 아니면 요청이 캐시를 완전히 우회해서 원서버로 바로 가도록 할 것인지에 대한 캐시 커뮤니케이션 결정을 동적으로 내린다. 캐시망 안에서의 콘텐츠 라우팅을 위해 설계된 캐시들은 다음과 같은 일을 할 수 있다.
    
    1. URL에 근거하여, 부모 캐시와 원 서버 중 하나를 동적으로 선택한다
    2. URL에 근거하여 특정 부모 캐시를 동적으로 선택한다
    3. 부모 캐시에게 가기 전에, 캐시된 사본을 로컬에서 찾아본다
    4. 다른 캐시들이 그들의 캐시된 콘텐츠에 부분적으로 접근할 수 있도록 허용하되, 그들의 캐시를 통한 인터넷 트랜짓은 허용되지 않는다.
- 캐시 처리 단계
1. 요청 받기 : 캐시는 네트워크로부터 도착한 요청메세지를 읽는다
2. 파싱 : 캐시는 메세지를 파싱하여 URL과 헤더들을 추출한다
3. 검색 : 캐시는 로컬 복사본이 있는지 검사하고, 사본이 없다면 사본을 받아와 로컬에 저장한다
4. 신선도 검사 : 캐시는 캐시된 사본이 충분히 신선한지 검사하고, 신선하지 않다면 변경사항이 있는지 서버에게 물어본다
5. 응답 생성 : 캐시는 새로운 헤더와 캐시된 본문으로 응답 메세지를 만든다
6. 발송 : 캐시는 네트워크를 통해 응답을 클라이언트에게 돌려준다
7. 로깅 : 선택적으로, 캐시는 로그파일에 트랜잭션에 대해 서술한 로그 하나를 남긴다